{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
  <h3 class="mb-3">📝 Inspection Feedback & Reviews</h3>

  <!-- ✅ Average Rating Section -->
  {% if average_rating %}
    <div class="mb-4">
      <h5>⭐ Average Rating: {{ average_rating|round(1) }}/5</h5>
      <div class="text-warning fs-4">
        {% for i in range(average_rating|round(0, 'floor')) %}
          ★
        {% endfor %}
        {% for i in range(5 - average_rating|round(0, 'floor')) %}
          ☆
        {% endfor %}
      </div>
    </div>
  {% endif %}

  {% if feedback_list %}
    {% for feedback in feedback_list %}
    <div class="card mb-4 shadow-sm">
      <div class="card-body">
        <h5>⭐ {{ feedback.rating }}/5</h5>
        <p>{{ feedback.comment }}</p>
        <small class="text-muted">
          From: {{ feedback.user.first_name }} {{ feedback.user.last_name }} |
          Booking ID: {{ feedback.booking_id }} |
          {{ feedback.created_at.strftime('%Y-%m-%d %H:%M') }}
        </small>

        {% if feedback.reply %}
          <hr>
          <strong>Agent Reply:</strong>
          <p class="text-secondary">{{ feedback.reply }}</p>
          <small class="text-muted">Replied on {{ feedback.replied_at.strftime('%Y-%m-%d %H:%M') }}</small>
        {% elif current_user.id == feedback.booking.agent_id %}
          <!-- Agent reply form -->
          <form method="POST" action="{{ url_for('seller_dashboard.reply_feedback', feedback_id=feedback.id) }}">
            <div class="mb-2 mt-2">
              <textarea name="reply" class="form-control" rows="2" placeholder="Reply to this feedback" required></textarea>
            </div>
            <button type="submit" class="btn btn-sm btn-outline-primary">Reply</button>
          </form>
        {% endif %}

        {% if current_user.id == feedback.user_id %}
          <div class="mt-3">
            <a href="{{ url_for('seller_dashboard.edit_feedback', feedback_id=feedback.id) }}" class="btn btn-sm btn-warning">✏️ Edit</a>
            <a href="{{ url_for('seller_dashboard.delete_feedback', feedback_id=feedback.id) }}" class="btn btn-sm btn-danger">🗑 Delete</a>
          </div>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  {% else %}
    <p class="alert alert-info">No feedback submitted yet.</p>
  {% endif %}
</div>
{% endblock %}
