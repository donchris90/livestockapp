{% extends "base.html" %}
{% block content %}
<div class="container mt-5">
  <h2 class="mb-4 text-center">üõ°Ô∏è My Escrow Transactions</h2>

  {% if buyer_escrows or seller_escrows %}
  <div class="row">

    <!-- Seller Escrows -->
    <div class="col-12 mb-5">
      <div class="card shadow border-0">
        <div class="card-header bg-success text-white fw-bold fs-5">
          üíº Escrows I Received (as Seller)
        </div>
        <div class="card-body">
          {% if seller_escrows %}
          <div class="table-responsive">
            <table class="table table-hover text-sm align-middle">
              <thead class="table-light">
                <tr class="text-nowrap">
                  <th>üì¶ Product</th>
                  <th>üí∞ Offer (‚Ç¶)</th>
                  <th>üßæ Fee</th>
                  <th>üî¢ Total</th>
                  <th>üßë Buyer</th>
                  <th>üìå Status</th>
                  <th>üìÖ Date</th>
                </tr>
              </thead>
              <tbody>
                {% for escrow in seller_escrows %}
                <tr>
                  <td>
                    <a href="{{ url_for('seller_dashboard.product_detail', product_id=escrow.product_id) }}"
                       class="text-decoration-none fw-semibold text-dark">View Product</a>
                  </td>
                  <td>‚Ç¶{{ escrow.base_amount | round(2) }}</td>
                  <td>‚Ç¶{{ escrow.escrow_fee | round(2) }}</td>
                  <td><strong>‚Ç¶{{ escrow.total_amount | round(2) }}</strong></td>
                  <td>{{ escrow.buyer_name }}</td>
                  <td>
                    <span class="badge bg-{{ 'success' if escrow.status == 'completed' else 'warning' }}">
                      {{ escrow.status.title() }}
                    </span>
                  </td>
                  <td>{{ escrow.created_at.strftime('%d %b %Y') }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <p class="text-muted">No escrow offers received yet.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Buyer Escrows -->
    <div class="col-12">
      <div class="card shadow border-0">
        <div class="card-header bg-primary text-white fw-bold fs-5">
          üßæ Escrows I Sent (as Buyer)
        </div>
        <div class="card-body">
          {% if buyer_escrows %}
          <div class="table-responsive">
            <table class="table table-hover text-sm align-middle">
              <thead class="table-light">
                <tr class="text-nowrap">
                  <th>üì¶ Product</th>
                  <th>üí∞ Offer (‚Ç¶)</th>
                  <th>üßæ Fee</th>
                  <th>üî¢ Total</th>
                  <th>üßë Seller</th>
                  <th>üìå Status</th>
                  <th>üìÖ Date</th>
                  <th>‚öôÔ∏è Action</th>
                </tr>
              </thead>
              <tbody>
                {% for escrow in buyer_escrows %}
                <tr>
                  <td>
                    <a href="{{ url_for('seller_dashboard.product_detail', product_id=escrow.product_id) }}"
                       class="text-decoration-none fw-semibold text-dark">View Product</a>
                  </td>
                  <td>‚Ç¶{{ escrow.base_amount | round(2) }}</td>
                  <td>‚Ç¶{{ escrow.escrow_fee | round(2) }}</td>
                  <td><strong>‚Ç¶{{ escrow.total_amount | round(2) }}</strong></td>
                  <td>{{ escrow.seller_name }}</td>
                  <td>
                    <span class="badge bg-{{ 'success' if escrow.status == 'completed' else 'warning' }}">
                  {% if escrow.status %}
    {{ escrow.status.title() }}
{% else %}
    <span class="text-muted">No status</span>
{% endif %}

                    </span>
                  </td>
                  <td>{% if escrow.created_at %}
    <td>{{ escrow.created_at.strftime('%d %b %Y') }}</td>
{% else %}
    <td class="text-muted">N/A</td>
{% endif %}
</td>
                  <td>
                    {% if not escrow.is_paid %}
                      {% if escrow.base_amount %}
                        <button class="btn btn-success btn-sm"
                                onclick="payWithPaystack({{ escrow.id }}, {{ (escrow.total_amount * 100)|int }}, '{{ current_user.email }}')">
                          Pay ‚Ç¶{{ escrow.total_amount | round(2) }}
                        </button>
                      {% else %}
                        <span class="badge bg-secondary">No Offer Yet</span>
                      {% endif %}

                    {% elif escrow.status == 'paid' and not escrow.order_completed %}
                      <form method="POST" action="{{ url_for('escrow.mark_complete', escrow_id=escrow.id) }}" style="display:inline;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button class="btn btn-warning btn-sm"
                                onclick="return confirm('Mark this order as delivered?')">
                          Mark as Delivered
                        </button>
                      </form>

                    {% elif escrow.status == 'delivered' and not escrow.order_completed %}
                      <form method="POST" action="{{ url_for('escrow.confirm_order', escrow_id=escrow.id) }}" style="display:inline;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button class="btn btn-primary btn-sm"
                                onclick="return confirm('Confirm and release payment to seller?')">
                          Confirm Order
                        </button>
                      </form>

                    {% elif escrow.status == 'completed' %}
                      <span class="badge bg-info">Completed</span>

                    {% else %}
                      <span class="text-muted">N/A</span>
                    {% endif %}

                    {% if current_user.role == 'admin' and escrow.is_paid and not escrow.order_completed %}
                      <form method="POST" action="{{ url_for('escrow.admin_mark_complete', escrow_id=escrow.id) }}" style="display:inline;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button class="btn btn-dark btn-sm mt-1"
                                onclick="return confirm('Admin: Mark this transaction as complete and release funds?')">
                          Admin Complete
                        </button>
                      </form>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <p class="text-muted">No escrow offers made yet.</p>
          {% endif %}
        </div>
      </div>
    </div>

  </div>
  {% else %}
  <div class="alert alert-info">
    <p class="mb-0">You have no escrow activity yet.</p>
  </div>
  {% endif %}
</div>

<script src="https://js.paystack.co/v1/inline.js"></script>

<script>
  function payWithPaystack(escrowId, amount, email) {
    var handler = PaystackPop.setup({
      key: "{{ paystack_public_key }}",
      email: email,
      amount: amount,
      currency: "NGN",
      ref: '' + Math.floor((Math.random() * 1000000000) + 1),
      callback: function(response) {
        window.location.href = "verify-payment/" + escrowId + "?reference=" + response.reference;
      },
      onClose: function() {
        alert('Transaction was not completed, window closed.');
      }
    });
    handler.openIframe();
  }
</script>
{% endblock %}
