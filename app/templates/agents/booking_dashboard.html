{% extends "agents/base.html" %}

{% block content %}
<div class="container mt-4">
  <h3 class="mb-4">📅 Agent Booking Requests</h3>

  <!-- Tabs for Filtering -->
  <ul class="nav nav-tabs mb-3">
    <li class="nav-item">
      <a class="nav-link {% if filter_type == 'upcoming' %}active{% endif %}" href="{{ url_for('agents.agent_bookings', filter='upcoming') }}">Upcoming</a>
    </li>
    <li class="nav-item">
      <a class="nav-link {% if filter_type == 'completed' %}active{% endif %}" href="{{ url_for('agents.agent_bookings', filter='completed') }}">Completed</a>
    </li>
  </ul>

  {% if bookings.items %}
    {% for booking in bookings.items %}
    <div class="card mb-4 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <h5>Booking #{{ booking.id }}</h5>
          <span class="badge bg-{{
            'secondary' if booking.status == 'pending' else
            'success' if booking.status == 'accepted' else
            'danger'
          }}">
            {{ booking.status|capitalize }}
          </span>
        </div>

        <p class="text-muted mb-1">
          📅 <strong>Scheduled:</strong>
          {% if booking.date %}
            {{ booking.date.strftime('%Y-%m-%d') }}
          {% endif %}
          {% if booking.time %}
            at {{ booking.time.strftime('%I:%M %p') }}
          {% endif %}
        </p>

        <hr>

        <div class="mb-3">
          <h6>👤 Buyer Information</h6>
          <p class="mb-1"><strong>Name:</strong> {{ booking.buyer.first_name }} {{ booking.buyer.last_name }}</p>
          <p class="mb-1"><strong>Location:</strong> {{ booking.buyer.state }}, {{ booking.buyer.city }}</p>
          <p class="mb-1"><strong>Phone:</strong> {{ booking.buyer.phone }}</p>
          <a href="https://wa.me/{{ booking.buyer.phone }}" class="btn btn-outline-success btn-sm me-2" target="_blank">💬 WhatsApp</a>
          <a href="{{ url_for('chat.chat_with_user', receiver_id=booking.buyer.id) }}" class="btn btn-outline-primary btn-sm" target="_blank">💬 Chat</a>
        </div>

        {% if filter_type == 'upcoming' %}
          {% if booking.status == 'pending' %}
            <form method="POST" action="{{ url_for('agents.update_booking_status', booking_id=booking.id) }}">
              <button name="action" value="accepted" class="btn btn-success btn-sm">Accept</button>
              <button name="action" value="rejected" class="btn btn-danger btn-sm">Reject</button>
            </form>
          {% endif %}

          {% if booking.status == 'accepted' and not booking.inspection_reported_at %}
            <div class="mt-4 p-3 border rounded bg-light">
              <h6>ℹ️ Upload pictures is disabled here.</h6>
              <p>Use the chat above to send pictures and communicate with the buyer to complete the booking.</p>
            </div>

            <form method="POST" action="{{ url_for('agents.submit_inspection', booking_id=booking.id) }}" class="mt-3">
              <div class="mb-2">
                <label for="inspection_report_{{ booking.id }}" class="form-label">Inspection Report</label>
                <textarea id="inspection_report_{{ booking.id }}" name="inspection_report" class="form-control" rows="4" required></textarea>
              </div>
              <button type="submit" class="btn btn-primary btn-sm">📤 Submit Inspection</button>
            </form>
          {% endif %}
        {% elif filter_type == 'completed' %}
          <div class="mt-3">
            <h6>📋 Inspection Report</h6>
            <p>{{ booking.inspection_report or 'Not available' }}</p>

            <h6>📌 Outcome:</h6>
            <p>{{ booking.inspection_outcome or 'Pending' }}</p>

            {% if not booking.inspection_marked_complete %}
              <span class="badge bg-warning">⏳ Pending buyer confirmation</span>
            {% else %}
              <span class="badge bg-success">✅ Buyer marked as complete</span>
            {% endif %}
          </div>
        {% endif %}
      </div>
    </div>
    {% endfor %}

    <!-- Pagination -->
    <nav aria-label="Page navigation example">
      <ul class="pagination justify-content-center">
        {% if bookings.has_prev %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('agents.agent_bookings', filter=filter_type, page=bookings.prev_num) }}">Previous</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Previous</span></li>
        {% endif %}

        {% for p in bookings.iter_pages(left_edge=2, right_edge=2, left_current=2, right_current=2) %}
          {% if p %}
            {% if p == bookings.page %}
              <li class="page-item active"><span class="page-link">{{ p }}</span></li>
            {% else %}
              <li class="page-item"><a class="page-link" href="{{ url_for('agents.agent_bookings', filter=filter_type, page=p) }}">{{ p }}</a></li>
            {% endif %}
          {% else %}
            <li class="page-item disabled"><span class="page-link">…</span></li>
          {% endif %}
        {% endfor %}

        {% if bookings.has_next %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('agents.agent_bookings', filter=filter_type, page=bookings.next_num) }}">Next</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Next</span></li>
        {% endif %}
      </ul>
    </nav>
  {% else %}
    <div class="alert alert-warning text-center">
      🚫 No {{ filter_type }} bookings available.
    </div>
  {% endif %}
</div>
{% endblock %}
