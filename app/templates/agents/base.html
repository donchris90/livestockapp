<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>

<!-- âœ… Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} mt-3 text-center">{{ message }}</div>
    {% endfor %}
  {% endif %}
{% endwith %}

<!-- âœ… Navigation -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark px-4">
  <a class="navbar-brand" href="{{ url_for('main.home') }}">Livestock Farm App</a>
  <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarAgent">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="navbarAgent">
    <ul class="navbar-nav ms-auto">

      <!-- Dashboard -->
      <li class="nav-item">
        <a class="nav-link" href="{{ url_for('agents.agent_dashboard') }}">ðŸ“‹ Dashboard</a>
      </li>
       <li class="nav-item">
       {% if current_user.role == 'agent' %}
  <a class="nav-link" href="{{ url_for('agents.agent_profile', agent_id=current_user.id) }}">ðŸ“‹ Profile</a>
{% endif %}


      </li>
 <li><a class="nav-link" href="{{ url_for('agents.agent_bookings') }}">ðŸ“‹ Bookings</a></li>
      <!-- ðŸ”” Notifications -->
      <li class="nav-item position-relative">
        <a class="nav-link" href="{{ url_for('agents.agent_notifications') }}">
          <i class="bi bi-bell"></i>
          {% if unread_count > 0 %}
            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
              {{ unread_count }}
              <span class="visually-hidden">unread notifications</span>
            </span>
          {% endif %}
        </a>
      </li>

      <!-- ðŸ’¬ Inbox -->
      <li class="nav-item">
        <a class="nav-link" href="{{ url_for('chat.inbox') }}">
          ðŸ’¬ Inbox
          {% if unread_message_count > 0 %}
            <span class="badge bg-danger">{{ unread_message_count }}</span>
          {% endif %}
        </a>
      </li>


      <!-- Logout -->
      <li class="nav-item">
        <a class="nav-link text-danger" href="{{ url_for('auth.logout') }}">Logout</a>
      </li>
    </ul>
  </div>
</nav>

<!-- âœ… Main Content Area -->
<main class="container mt-4">
  {% block content %}{% endblock %}
</main>

<!-- âœ… Toast Notifications -->
<div id="toast-container" style="position: fixed; top: 1rem; right: 1rem; z-index: 9999;"></div>

<!-- âœ… Socket.IO Scripts -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
  const socket = io();

  socket.on('connect', () => {
    console.log("âœ… Connected to Socket.IO");
    socket.emit('join', { user_id: "{{ current_user.id }}" });
  });

  socket.on('new_booking', data => {
    showToast(data.message);
  });

  socket.on('inspection_notification', data => {
    showToast(data.message);
  });

  function showToast(msg) {
    const toast = document.createElement("div");
    toast.className = "toast align-items-center text-white bg-success border-0 show";
    toast.setAttribute("role", "alert");
    toast.setAttribute("aria-live", "assertive");
    toast.setAttribute("aria-atomic", "true");
    toast.style.minWidth = "250px";
    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">${msg}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>`;
    document.getElementById("toast-container").appendChild(toast);
    setTimeout(() => toast.remove(), 8000);
  }
</script>

</body>
</html>
