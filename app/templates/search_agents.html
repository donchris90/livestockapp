{% extends "base.html" %}
{% block content %}

<div class="my-5 bg-white p-4 rounded shadow-sm">
  <hr class="my-4">
  <div class="bg-light p-4 rounded shadow">
    <h5>Need Help With Inspection or Delivery?</h5>
    <p>
      Find agents or logistics providers around
      <strong>{{ product.state }}{% if product.city %}, {{ product.city }}{% endif %}</strong>.
    </p>

    <div class="d-flex gap-2 mb-3">
      <button id="findAgentBtn" class="btn btn-outline-primary btn-sm">Find Nearby Agents</button>
      <button id="findLogisticsBtn" class="btn btn-outline-success btn-sm">Find Nearby Logistics</button>
    </div>

    <div id="nearbyResults" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
      <!-- Dynamic cards + modals injected here -->
    </div>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function () {
  function capitalizeWords(name) {
    if (!name) return '';
    return name
      .split(' ')
      .map(word => word.charAt(0).toUpperCase() + word.slice(1))
      .join(' ');
  }

  const productId = {{ product.id }};
  const productTitle = {{ product.title | tojson }};

  function renderResults(role, data) {
    const resultsDiv = document.getElementById('nearbyResults');
    resultsDiv.innerHTML = '';

    if (!data || data.length === 0) {
      resultsDiv.innerHTML = `<div class="col-12"><div class="alert alert-warning">No nearby ${role}s found.</div></div>`;
      return;
    }

    data.forEach(user => {
      const phone = user.phone ? user.phone.replace(/\s+/g, '') : '';
      const whatsappLink = phone ? `https://wa.me/${phone.startsWith('0') ? '234' + phone.slice(1) : phone}` : '';
      const fullName = capitalizeWords(user.name || 'Unnamed Agent');
      const city = capitalizeWords(user.city || '');
      const state = capitalizeWords(user.state || '');
      const distance = parseFloat(user.distance_km || 0).toFixed(2);
      const hours = (distance / 60).toFixed(1);
      const online = user.is_online ? 'Online' : 'Offline';
      const onlineBadge = user.is_online ? 'bg-success' : 'bg-secondary';
      const rating = user.avg_rating || 0;
      const reviews = user.review_count || 0;

      // Booking Modal
      const bookingModal = `
<div class="modal fade" id="bookingModal${user.id}" tabindex="-1" aria-labelledby="bookingModalLabel${user.id}" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST" action="/book-agent/${user.id}/${productId}">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Book ${fullName} for "<span class="text-primary">${productTitle}</span>"</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="bookingDate${user.id}" class="form-label">Select Date</label>
            <input type="date" name="preferred_date" class="form-control" id="bookingDate${user.id}" required>
          </div>
          <div class="mb-3">
            <label for="message${user.id}" class="form-label">Message (optional)</label>
            <textarea name="message" class="form-control" rows="3" placeholder="Add any notes..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Confirm Booking</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </form>
  </div>
</div>`;

      // Profile Modal
      const profileModal = `
<div class="modal fade" id="agentModal${user.id}" tabindex="-1" aria-labelledby="agentModalLabel${user.id}" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">${fullName}'s Profile</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>Specialty:</strong> ${user.specialty || 'N/A'}</p>
        <p><strong>Email:</strong> ${user.email || 'N/A'}</p>
        <p><strong>Phone:</strong> ${user.phone || 'N/A'}</p>
        <p><strong>Location:</strong> ${city}, ${state}</p>
        <p><strong>Status:</strong> <span class="badge ${onlineBadge}">${online}</span></p>
        <p><strong>Rating:</strong> ${rating} ★ (${reviews} reviews)</p>
        <p><strong>About:</strong> ${user.about || 'No description provided.'}</p>
      </div>
      <div class="modal-footer">
        <a href="${whatsappLink}" class="btn btn-success" target="_blank">WhatsApp</a>
        <a href="/chat/chat/${user.id}" class="btn btn-primary">Chat</a>
        <a href="/book-agent/${user.id}/${productId}" class="btn btn-warning">Book Now</a>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>`;

      // Agent Card
      const card = `
<div class="col">
  <div class="card h-100 border-0 shadow-sm">
    <div class="card-body p-3">
      <h6 class="fw-bold mb-1">${fullName}</h6>
      <p class="mb-1 text-muted small">${city}, ${state}</p>
      <p class="mb-1 small">${distance} km away (~${hours} hrs drive)</p>
      <span class="badge ${onlineBadge} mb-2">${online}</span>
      <p class="small mb-1">Rating: <strong>${rating}★</strong> (${reviews} reviews)</p>
      <div class="d-flex flex-wrap gap-2 mt-2">
        <a href="/chat/chat/${user.id}" class="btn btn-sm btn-outline-info">Chat</a>
        <a href="${whatsappLink}" class="btn btn-sm btn-outline-success" target="_blank">WhatsApp</a>
        <button class="btn btn-sm btn-outline-warning" data-bs-toggle="modal" data-bs-target="#bookingModal${user.id}">Book Now</button>
        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#agentModal${user.id}">View Profile</button>
      </div>
    </div>
  </div>
</div>`;

      resultsDiv.innerHTML += bookingModal + profileModal + card;
    });
  }

  function fetchNearby(role) {
    const resultsDiv = document.getElementById('nearbyResults');
    resultsDiv.innerHTML = `<div class="col"><div class="alert alert-info">Searching for nearby ${role}s...</div></div>`;

    if (!navigator.geolocation) {
      resultsDiv.innerHTML = `<div class="col"><div class="alert alert-danger">Geolocation not supported by your browser.</div></div>`;
      return;
    }

    navigator.geolocation.getCurrentPosition(function (position) {
      const latitude = position.coords.latitude;
      const longitude = position.coords.longitude;

      fetch('/agents/search-live-' + role + 's', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': "{{ csrf_token() }}"
        },
        body: JSON.stringify({ latitude, longitude })
      })
        .then(res => res.json())
        .then(data => renderResults(role, data))
        .catch(err => {
          console.error(`Error fetching ${role}s:`, err);
          resultsDiv.innerHTML = `<div class="col"><div class="alert alert-danger">Failed to fetch nearby ${role}s.</div></div>`;
        });
    }, () => {
      resultsDiv.innerHTML = `<div class="col"><div class="alert alert-danger">Location access denied.</div></div>`;
    });
  }

  document.getElementById('findAgentBtn').addEventListener('click', () => fetchNearby('agent'));
  document.getElementById('findLogisticsBtn').addEventListener('click', () => fetchNearby('logistics'));
});
</script>



{% endblock %}
